\NeedsTeXFormat{LaTeX2e}[1999/01/01]
\ProvidesPackage{mybib}[2011/03/28]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Declare package options %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% For the intermediate bibliographies
\newif\if@minibib \@minibibfalse
\DeclareOption{minibib}{\@minibibtrue}
% What is the section level for the bibliographies
\newif\if@minibibchapter \@minibibchapterfalse
\DeclareOption{minibibchapter}{\@minibibchaptertrue\@minibibtrue}
\newif\if@minibibsection \@minibibsectionfalse
\DeclareOption{minibibsection}{\@minibibsectiontrue\@minibibtrue}
% For more powerful command about bibliography citations
\newif\if@natbib \@natbibfalse
\DeclareOption{natbib}{\@natbibtrue}
% Define the section level of titles
\newif\if@minibibchaptertitle \@minibibchaptertitlefalse
\DeclareOption{minibibchaptertitle}{\@minibibchaptertitletrue}
\newif\if@minibibsectiontitle \@minibibsectiontitlefalse
\DeclareOption{minibibsectiontitle}{\@minibibsectiontitletrue}
% To have back references (page number) in the bibliographies
\newif\if@backref \@backreffalse
\DeclareOption{backref}{\@backreftrue}
% Use the 'biblatex' package
\newif\if@biblatex \@biblatexfalse
\DeclareOption{biblatex}{\@biblatextrue}
% In case of unknown options
\DeclareOption*{%
	\PackageWarning{mybib}{Unknown option `\CurrentOption'}%
}

\ProcessOptions

%% Options to pass to packages
\if@minibib
	\if@biblatex
		\if@minibibchapter
			\PassOptionsToPackage{refsection=chapter,refsegment=section}{biblatex}
		\fi
		\if@minibibsection
			\PassOptionsToPackage{refsection=chapter,refsegment=section}{biblatex}
		\fi
	\else
		\PassOptionsToPackage{globalcitecopy}{bibunits}
		\if@minibibchapter
			\if@minibibchaptertitle
				\PassOptionsToPackage{sectionbib}{bibunits}
			\else
				\PassOptionsToPackage{subsectionbib}{bibunits}
			\fi
		\fi
		\if@minibibsection
			\if@minibibsectiontitle
				\PassOptionsToPackage{subsectionbib}{bibunits}
			\else
				\PassOptionsToPackage{sectionbib}{bibunits}
			\fi
		\fi
	\fi
\fi
\if@natbib
	\PassOptionsToPackage{backref}{biblatex}
\fi
\if@backref
	\if@biblatex
		\PassOptionsToPackage{backref}{biblatex}
	\else
		\PassOptionsToPackage{backref}{hyperref}
	\fi
\fi

%% Packages to call
% The biblatex is the best package to make bibliographies
\if@biblatex
	\RequirePackage{csquotes}
	\RequirePackage[sorting=nyt,hyperref=auto,abbreviate=false,backend=biber,style=authoryear,citestyle=authoryear-comp,bibstyle=authoryear,block=space,maxcitenames=2,maxbibnames=99]{biblatex}
\else
	% To generate entry in table of content for bibliographies (and other)
	\RequirePackage{tocbibind}
	% For more powerful command for bibliography citations
	\if@natbib
		\RequirePackage[sort,comma,square]{natbib}
	\fi
	% For seperated bibliographies in sections or chapters
	% Compatible with natbib
	\if@minibib
		\RequirePackage{bibunits}
	\fi
\fi

%%%%%%%%%%%%%%%%%%%%%%%
%% New configuration %%
%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%
%% New commands %%
%%%%%%%%%%%%%%%%%%
%% To include a bibliography
\newcommand{\mybiblio}[1][]{%
	\if@biblatex
		\def\my@args@one{#1}%
		\defbibfilter{all}{\keyword{Simard}}
		\ifx\my@args@one\@empty%
			\printbibliography[heading=bibintoc,filter=all]
		\else%
			\printbibliography[heading=bibintoc,filter=all,#1]
		\fi%
	\else%
		\bibliographystyle{apalike}%
		\bibliography{biblio}%
	\fi%
}
\if@minibib
	%% Define the necessary command to create the bibunits bibliographies
	%% This command should be put after '\begin{document}'
	\newcommand{\mydominibib}[2][apalike]{%
		% Define the bibunit level
		% If neither 'minibibchapter', nor 'minibibsection' was defined,
		% then '\begin{bibunit} ... \end{bibunit}' can be used.
		\if@minibibchapter
			\bibliographyunit[\chapter]
		\fi
		\if@minibibsection
			\bibliographyunit[\section]
		\fi
		% Define default files and style for bibunits sections
		\defaultbibliography{#2}%
		\defaultbibliographystyle{#1}%
	}
\fi
\if@minibib
	\if@biblatex
		\newcommand{\myminibiblio}[1][]{%
			\def\my@args@one{#1}%
			\ifx\my@args@one\@empty%
				\if@minibibchapter
					\printbibliography[heading=subbibintoc,section=\the\c@refsection]%
				\else
					\if@minibibsection
						\printbibliography[heading=subbibintoc,segment=\the\c@refsegment]%
					\else
						\printbibliography[heading=subbibintoc]%
					\fi
				\fi
			\else%
				\if@minibibchapter
					\printbibliography[heading=subbibintoc,section=\the\c@refsection,#1]%
				\else
					\if@minibibsection
						\printbibliography[heading=subbibintoc,segment=\the\c@refsegment,#1]%
					\else
						\printbibliography[heading=subbibintoc,#1]%
					\fi
				\fi
			\fi%
		}
	\else
		\newcommand{\myminibiblio}[1][]{%
			\def\args@one{#1}%
			\ifx\args@one\@empty%
				\putbib%
			\else%
				\putbib[\args@one]%
			\fi%
		}
	\fi
\else
	\newcommand{\myminibiblio}[1][]{%
		\PackageWarning{mybib}{You should use `minibib' package option to do mini bibliographies.}
	}
\fi
% Replace the command '\cite'
% Thanks to the 'natbib' package, you can use:
% - \mycite{<ref>} -> [<author>, <year>]
% - \mycite[author]{<ref>} -> <author> [<year>]
\if@biblatex
	\DeclareCiteCommand{\my@mycite}[\mkbibbrackets]%
		{\usebibmacro{cite:init}%
			\usebibmacro{prenote}}%
		{\usebibmacro{citeindex}%
			\usebibmacro{cite}}%
		{}%
		{\usebibmacro{postnote}}
	\DeclareCiteCommand{\my@myciteauthor}%
		{\usebibmacro{cite:init}%
			\usebibmacro{prenote}}%
		{\usebibmacro{citeindex}%
			\printnames{labelname}~\bibopenbracket\usebibmacro{citeyear}\bibclosebracket}%
		{}%
		{\usebibmacro{postnote}}
	\newcommand{\mycite}[2][]{%
		\ifthenelse{\equal{#1}{author}}%
			{\my@myciteauthor{#2}}%
			{\my@mycite{#2}}%
	}
\else
	\if@natbib
		\newcommand{\mycite}[2][]{%
			\ifthenelse{\equal{#1}{author}}%
				{\citet{#2}\xspace}%
				{\citep{#2}\xspace}%
		}
	\else
		\newcommand{\mycite}[2][]{%
			\cite{#2}\xspace%
		}
	\fi
\fi

% End of package
\endinput
